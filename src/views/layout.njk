<!DOCTYPE html>
<html lang="en" data-theme="{{ userPreferences.theme or 'dark' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title or 'Logsify' }}</title>
    <link href="/css/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-base-100 to-base-200">
    <!-- Modern Navigation Bar - Always Visible -->
    <div class="navbar bg-base-100/80 backdrop-blur-sm shadow-lg border-b border-base-300 sticky top-0 z-50">
        <div class="navbar-start">
            <a href="{{ '/' if not user else '/dashboard' }}" class="btn btn-ghost text-xl font-bold">
                <div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-lg flex items-center justify-center text-white">
                    <i class="fas fa-chart-line text-sm"></i>
                </div>
                <span class="bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                    Logsify
                </span>
            </a>
        </div>
        
        <!-- Center Navigation -->
        <div class="navbar-center hidden lg:flex">
            {% if user %}
            <ul class="menu menu-horizontal px-1 gap-2">
                <li>
                    <a href="/dashboard/logs" 
                       class="btn btn-ghost btn-sm {{ 'btn-active' if currentPath and currentPath | safeStartsWith('/dashboard/logs') }}">
                        <i class="fas fa-list-alt text-sm"></i>
                        Logs
                    </a>
                </li>
                <li>
                    <a href="/dashboard/settings" 
                       class="btn btn-ghost btn-sm {{ 'btn-active' if currentPath and currentPath | safeStartsWith('/dashboard/settings') }}">
                        <i class="fas fa-cog text-sm"></i>
                        Settings
                    </a>
                </li>
            </ul>
            {% else %}
            <div class="flex items-center gap-4 text-base-content/70">
                <span class="text-sm">Modern logging dashboard for your applications</span>
            </div>
            {% endif %}
        </div>
        
        <!-- Right Side -->
        <div class="navbar-end gap-2">
            <!-- Theme Switcher -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle btn-sm tooltip tooltip-bottom" data-tip="Switch Theme">
                    <i class="fas fa-palette text-lg"></i>
                </div>
                <ul tabindex="0" class="dropdown-content z-[50] menu p-3 shadow-xl bg-base-100 rounded-2xl w-64 border border-base-300">
                    <li class="menu-title">
                        <span><i class="fas fa-palette text-primary"></i> Choose Theme</span>
                    </li>
                    <div class="grid grid-cols-2 gap-2 p-2">
                        <li><a onclick="setTheme('dark')" class="btn btn-sm btn-ghost justify-start">
                            <i class="fas fa-moon text-gray-400"></i>Dark</a></li>
                        <li><a onclick="setTheme('light')" class="btn btn-sm btn-ghost justify-start">
                            <i class="fas fa-sun text-yellow-400"></i>Light</a></li>
                        <li><a onclick="setTheme('cyberpunk')" class="btn btn-sm btn-ghost justify-start">
                            <i class="fas fa-robot text-pink-400"></i>Cyber</a></li>
                        <li><a onclick="setTheme('synthwave')" class="btn btn-sm btn-ghost justify-start">
                            <i class="fas fa-wave-square text-purple-400"></i>Synth</a></li>
                        <li><a onclick="setTheme('forest')" class="btn btn-sm btn-ghost justify-start">
                            <i class="fas fa-tree text-green-400"></i>Forest</a></li>
                        <li><a onclick="setTheme('aqua')" class="btn btn-sm btn-ghost justify-start">
                            <i class="fas fa-water text-blue-400"></i>Aqua</a></li>
                    </div>
                </ul>
            </div>
            
            {% if user %}
            <!-- User Menu -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                    <div class="w-8 rounded-full ring-2 ring-primary ring-offset-2 ring-offset-base-100">
                        <img src="{{ user.avatar or '/images/default-avatar.png' }}" alt="Avatar" />
                    </div>
                </div>
                <ul tabindex="0" class="dropdown-content z-[50] menu p-3 shadow-xl bg-base-100 rounded-2xl w-56 border border-base-300">
                    <li class="menu-title">
                        <div class="flex items-center gap-3">
                            <div class="avatar">
                                <div class="w-8 rounded-full">
                                    <img src="{{ user.avatar or '/images/default-avatar.png' }}" alt="Avatar" />
                                </div>
                            </div>
                            <div>
                                <div class="font-semibold">{{ user.name }}</div>
                                <div class="text-xs text-base-content/60">@{{ user.username }}</div>
                            </div>
                        </div>
                    </li>
                    <div class="divider my-2"></div>
                    <li><a href="/dashboard/settings" class="gap-3">
                        <i class="fas fa-user-cog"></i>Settings</a></li>
                    <li><a href="/dashboard/logs" class="gap-3">
                        <i class="fas fa-list-alt"></i>View Logs</a></li>
                    <div class="divider my-2"></div>
                    <li>
                        <form method="POST" action="/auth/logout" class="w-full">
                            <button type="submit" class="w-full text-left gap-3 text-error hover:bg-error/10">
                                <i class="fas fa-sign-out-alt"></i>Logout
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
            {% else %}
            <!-- Auth Button -->
            <a href="/auth/github" class="btn btn-primary btn-sm gap-2">
                <i class="fab fa-github"></i>
                Sign In
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Main Content with Modern Styling -->
    <main class="min-h-screen">
        {% if not user %}
        <!-- Landing page container -->
        <div class="hero min-h-[calc(100vh-4rem)]">
        {% else %}
        <!-- Dashboard container -->
        <div class="container mx-auto px-4 py-8 max-w-7xl">
        {% endif %}
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Modern Footer -->
    <footer class="footer footer-center p-8 bg-base-200/50 text-base-content border-t border-base-300">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-lg flex items-center justify-center text-white">
                <i class="fas fa-chart-line text-sm"></i>
            </div>
            <div>
                <p class="font-semibold">Â© 2024 Logsify</p>
                <p class="text-sm text-base-content/60">Modern Logging Dashboard</p>
            </div>
        </div>
    </footer>

    <script>
        // Enhanced Theme Management with User Preferences
        async function setTheme(theme) {
            console.log('Setting theme to:', theme);
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Update user preferences if logged in
            if (document.querySelector('.avatar')) {
                try {
                    await fetch('/api/preferences', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ theme })
                    });
                } catch (error) {
                    console.log('Could not save theme preference:', error);
                }
            }
            
            // Close dropdown
            document.activeElement.blur();
            console.log('Theme applied successfully');
        }

        // Load theme on page load
        document.addEventListener('DOMContentLoaded', async function() {
            let theme = '{{ userPreferences.theme or "dark" }}';
            
            // Override with localStorage for immediate feedback
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                theme = savedTheme;
            }
            
            console.log('Loading theme:', theme);
            document.documentElement.setAttribute('data-theme', theme);
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    dropdown.removeAttribute('open');
                    dropdown.querySelector('[tabindex]')?.blur();
                });
            }
        });

        // Auto-refresh functionality for logs page
        if (window.location.pathname.includes('/dashboard/logs')) {
            const autoRefreshEnabled = {{ userPreferences.autoRefresh | lower }};
            if (autoRefreshEnabled) {
                setInterval(() => {
                    const checkbox = document.getElementById('auto-refresh');
                    if (checkbox && checkbox.checked) {
                        window.location.reload();
                    }
                }, 30000);
            }
        }
        
        // Modern loading states
        window.addEventListener('beforeunload', function() {
            document.body.classList.add('loading');
        });
    </script>
</body>
</html>